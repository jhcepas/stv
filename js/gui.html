<!DOCTYPE HTML>
<html>
    <head>
            <script src="./jquery.js"></script>
    <style>
      body {
        margin: 10px;
        padding: 100px;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="1000" height="1000"></canvas>

    <script>
     var current_zoom = 1.0;
     var current_x = 0;
     var current_y = 0;


      function writeMessage(canvas, message) {
        var context = canvas.getContext('2d');
        context.clearRect(300, 10, 1000, 25);
        context.font = '18pt Calibri';
        context.fillStyle = 'black';
        context.fillText(message, 300, 25);
         //context.drawImage(img, 10, 10);
      }
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      var img = new Image();

     img.onload = function(){
         console.log('DRAWING');

         context.drawImage(img, 0, 0);
         }
    //context.drawImage(img, 40, 40);
    context.fillStyle= 'orange';
    context.fillRect(0, 0, 1000, 1000);
     var canvasOffset=$("#myCanvas").offset();
     var offsetX=canvasOffset.left;
     var offsetY=canvasOffset.top;
     var canvasWidth=canvas.width;
     var canvasHeight=canvas.height;
     var isDragging=false;
     var drag_pos = undefined;

     function handleMouseDown(e){
        drag_pos = getMousePos(canvas, e)
        isDragging=true;
     }


     function update(){
         $.get('http://localhost:8090/get_region/'+current_zoom+'/'+current_x+'/'+current_y+'/1000/1000').done(function (d){
             img.src = 'data:image/  png;base64,'+d.img;
             //console.log(img.src);
             //context.drawImage(img, 0, 0);
                 });

     }

     function handleMouseUp(e){

         if (isDragging){
             isDragging=false;
             new_pos = getMousePos(canvas, e);
             console.log(new_pos, drag_pos, current_x, drag_pos.x-new_pos.x)
             current_x = Math.max(0, current_x + (drag_pos.x-new_pos.x)*current_zoom);
             current_y = Math.max(0, current_y + (drag_pos.y-new_pos.y)*current_zoom);
             update();
         }
     }

     function handleMouseOut(e){
         console.log('outside boundaries');
         // user has left the canvas, so clear the drag flag
         //isDragging=false;
     }

     function handleMouseMove(e){
         if(isDragging){
             new_pos = getMousePos(canvas, e);

             writeMessage(canvas, [(drag_pos.x-new_pos.x)/current_zoom, '/', (drag_pos.y-new_pos.y)/current_zoom]);
         }else {
             p = getMousePos(canvas, e);
             writeMessage(canvas,[p.x, p.y, current_x, current_y, current_zoom]);
             }
     }

     $("#myCanvas").mousedown(function(e){handleMouseDown(e);});
     $("#myCanvas").mousemove(function(e){handleMouseMove(e);});
     $("#myCanvas").mouseup(function(e){handleMouseUp(e);});
     $("#myCanvas").mouseout(function(e){handleMouseOut(e);});

     var last_timeout = undefined;
     $("#myCanvas").bind('mousewheel DOMMouseScroll',
                         function(e){

                             var prevent = function() {
                                 e.stopPropagation();
                                 e.preventDefault();
                                 e.returnValue = false;
                                 return false;
                             }

                             if (e.originalEvent.wheelDelta > 0){
                               var sc = 1.05;
                             } else {
                                 var sc = 0.95;
                                 }

                             var new_zoom = current_zoom * sc;
                             pos = getMousePos(canvas, e);
                             var zoom_change = new_zoom - current_zoom;
                             var offsetX = (pos.x * zoom_change);
                             var offsetY = (pos.y * zoom_change);


                             clearTimeout(last_timeout);
                             last_timeout = window.setTimeout(function(){
                                 current_x = Math.max(0, current_x + offsetX)
                                 current_y = Math.max(0, current_y + offsetY)
                                 current_zoom = new_zoom;
                                 console.log('scrolling down !', sc, new_zoom); update();}, 25);

                             return prevent();
                         }

     );




    </script>
  </body>
</html>
